---
# ============================================================================
# üîß ZOOKEEPER EMERGENCY V2 - CORRE√á√ÉO CR√çTICA DOS LOOPS
# ============================================================================
# AN√ÅLISE: FASE 1 falhou - ainda m√∫ltiplas inst√¢ncias e health checks falhando
# CORRE√á√ÉO V2: Simplificar ao m√°ximo, foco em estabilidade b√°sica
# ============================================================================

services:
  # ============================================================================
  # üîß ZOOKEEPER V2 - ULTRA SIMPLIFICADO PARA ESTABILIDADE
  # ============================================================================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.9.0
    hostname: conexao-zookeeper
    environment:
      # üîß CONFIGURA√á√ÉO M√çNIMA STANDALONE
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      # üö® REMOVIDO: ZOOKEEPER_SERVERS (causava conflito)
      # üö® REMOVIDO: ZOOKEEPER_SERVER_ID (n√£o necess√°rio standalone)
      # üõ°Ô∏è CONFIGURA√á√ïES DE ESTABILIDADE
      ZOOKEEPER_SYNC_LIMIT: 2
      ZOOKEEPER_INIT_LIMIT: 10
      ZOOKEEPER_MAX_CLIENT_CNXNS: 60
      ZOOKEEPER_AUTOPURGE_SNAP_RETAIN_COUNT: 3
      ZOOKEEPER_AUTOPURGE_PURGE_INTERVAL: 24
      # üöÄ JAVA HEAP OTIMIZADO
      KAFKA_HEAP_OPTS: "-Xmx256m -Xms128m"
    networks:
      conexao-network-swarm:
        aliases:
          - conexao-zookeeper
          - zookeeper
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data
      - zookeeper_logs:/var/lib/zookeeper/log
    healthcheck:
      # ü©∫ HEALTH CHECK ULTRA SIMPLES - SEM DEPEND√äNCIAS EXTERNAS
      test: ["CMD", "sh", "-c", "echo ruok | nc localhost 2181 || zkServer.sh status"]
      interval: 45s
      timeout: 20s
      retries: 3
      start_period: 180s
    deploy:
      # üõ°Ô∏è CONSTRAINT MAIS RIGOROSO
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
        # üö® CONSTRAINT ALTERNATIVO se max_replicas_per_node n√£o funciona
        preferences:
          - spread: node.id
      restart_policy:
        # üîß RESTART POLICY ULTRA CONSERVADORA
        condition: on-failure
        delay: 120s  # 2 minutos entre tentativas
        max_attempts: 2  # Apenas 2 tentativas
        window: 900s     # 15 minutos de janela
      update_config:
        parallelism: 1
        delay: 60s
        failure_action: rollback
        monitor: 120s
        order: stop-first  # üö® PARAR ANTES DE INICIAR NOVO
      rollback_config:
        parallelism: 1
        delay: 60s
        failure_action: pause
        monitor: 120s
      resources:
        limits:
          # üöÄ RESOURCES MAIS CONSERVADORES
          memory: 800M
          cpus: '0.4'
        reservations:
          memory: 400M
          cpus: '0.2'
      # üè∑Ô∏è LABELS PARA DEBUG
      labels:
        - "zookeeper.instance=unique"
        - "zookeeper.version=emergency-v2"
        - "zookeeper.mode=standalone-fixed"

# ============================================================================
# üîê VOLUMES EXTERNOS (mantidos)
# ============================================================================
volumes:
  zookeeper_data:
    external: true
    name: zookeeper_data
  zookeeper_logs:
    external: true
    name: zookeeper_logs

# ============================================================================
# üåê NETWORKS EXTERNOS (mantidos)
# ============================================================================
networks:
  conexao-network-swarm:
    external: true
    name: conexao-network-swarm