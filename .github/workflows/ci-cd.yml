name: "ğŸ§© Zookeeper Infrastructure â€“ CI/CD"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Concurrency control para evitar execuÃ§Ãµes simultÃ¢neas
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      id-token: write
    env:
      COMPOSE_FILE: docker-compose.yml
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_PEER_PORT: 2888
      ZOOKEEPER_LEADER_PORT: 3888
    steps:
      - name: Checkout
        uses: actions/checkout@v4.3.0
        with:
          fetch-depth: 1

      - name: Validate Azure identifiers (OIDC)
        env:
          AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
          AZURE_KEYVAULT_NAME: ${{ vars.AZURE_KEYVAULT_NAME }}
          AZURE_KEYVAULT_ENDPOINT: ${{ vars.AZURE_KEYVAULT_ENDPOINT }}
        run: |
          set -Eeuo pipefail
          missing=()
          for var in AZURE_CLIENT_ID AZURE_TENANT_ID AZURE_SUBSCRIPTION_ID; do
            if [[ -z "${!var:-}" ]]; then
              missing+=("$var")
            fi
          done
          if (( ${#missing[@]} )); then
            printf 'âŒ Repository Variables obrigatÃ³rias ausentes: %s\n' "${missing[*]}"
            exit 1
          fi
          echo "âœ… Identificadores Azure OIDC configurados via vars"
          
          # Aplicar mÃ¡scara para proteÃ§Ã£o (mesmo que sejam apenas IDs)
          echo "::add-mask::${AZURE_CLIENT_ID}"
          echo "::add-mask::${AZURE_TENANT_ID}"
          echo "::add-mask::${AZURE_SUBSCRIPTION_ID}"
          
          if [[ -n "${AZURE_KEYVAULT_NAME:-}" ]]; then
            echo "â„¹ï¸ Key Vault configurado: ${AZURE_KEYVAULT_NAME}"
            echo "::add-mask::${AZURE_KEYVAULT_NAME}"
          else
            echo 'â„¹ï¸ Key Vault nÃ£o configurado (Zookeeper nÃ£o requer segredos do Key Vault)'
          fi
          if [[ -n "${AZURE_KEYVAULT_ENDPOINT:-}" ]]; then
            echo "::add-mask::${AZURE_KEYVAULT_ENDPOINT}"
          fi

      - name: Ensure Python deps
        run: |
          set -Eeuo pipefail
          if ! command -v python3 >/dev/null 2>&1; then
            echo 'âŒ python3 nÃ£o estÃ¡ disponÃ­vel no runner self-hosted.' >&2
            exit 1
          fi
          python3 -c "import importlib.util, subprocess, sys; import importlib; spec = importlib.util.find_spec('yaml'); subprocess.check_call([sys.executable, '-m', 'pip', 'install', '--user', 'PyYAML']) if spec is None else None"
          echo "âœ… DependÃªncias Python disponÃ­veis"

      - name: Validate YAML files
        run: |
          set -Eeuo pipefail
          python3 -c "import pathlib, yaml; [yaml.safe_load(pathlib.Path(p).read_text(encoding='utf-8')) for p in ('docker-compose.yml',)]; print('âœ… YAML vÃ¡lido: docker-compose.yml')"

      - name: Validate Docker Compose
        run: |
          set -Eeuo pipefail
          docker compose -f docker-compose.yml config -q
          echo "âœ… docker-compose.yml vÃ¡lido"
          
      - name: Validate Zookeeper Configuration
        run: |
          set -Eeuo pipefail
          # Verificar se as portas do Zookeeper estÃ£o configuradas
          if ! grep -q "2181:2181" docker-compose.yml; then
            echo "âŒ Zookeeper client port (2181) nÃ£o configurada"
            exit 1
          fi
          
          # Verificar se hÃ¡ configuraÃ§Ãµes de ambiente Zookeeper
          if ! grep -q "ZOOKEEPER_" docker-compose.yml; then
            echo "âš ï¸ ConfiguraÃ§Ãµes ZOOKEEPER_ nÃ£o encontradas (pode ser normal para configuraÃ§Ã£o bÃ¡sica)"
          else
            echo "âœ… ConfiguraÃ§Ãµes ZOOKEEPER_ encontradas"
          fi
          
          # Verificar se hÃ¡ volumes persistentes configurados
          if ! grep -q "zookeeper_data" docker-compose.yml; then
            echo "âš ï¸ Volume persistente zookeeper_data nÃ£o configurado"
          else
            echo "âœ… Volume persistente zookeeper_data configurado"
          fi
          
          echo "âœ… ConfiguraÃ§Ã£o Zookeeper validada"

      - name: Security scan (comprehensive)
        run: |
          set -Eeuo pipefail
          
          # Verificar passwords hardcoded
          if grep -R "password[[:space:]]*:[[:space:]]*['\"]" --include="*.yml" docker-compose.yml 2>/dev/null | grep -v '\${'; then
            echo "âš ï¸ PossÃ­vel credencial hardcoded detectada"
            exit 1
          fi
          
          # Verificar tokens e secrets
          if grep -E "(token|secret|key|password)[[:space:]]*:[[:space:]]*['\"][a-zA-Z0-9]{16,}" docker-compose.yml 2>/dev/null | grep -v '\${'; then
            echo "âš ï¸ PossÃ­vel token/secret hardcoded detectado"
            exit 1
          fi
          
          # Verificar variÃ¡veis de ambiente sensÃ­veis nÃ£o mapeadas
          if grep -E "(AZURE_|AWS_|GCP_|DATABASE_)[A-Z_]*[[:space:]]*:" docker-compose.yml 2>/dev/null | grep -v '\${'; then
            echo "âš ï¸ VariÃ¡vel de ambiente sensÃ­vel pode estar hardcoded"
            exit 1
          fi
          
          echo "âœ… Nenhum segredo hardcode identificado"

  deploy:
    needs: validate
    runs-on: [ self-hosted, Linux, X64, conexao, conexao-de-sorte-zookeeper-infraestrutura ]
    timeout-minutes: 25
    permissions:
      contents: read
      id-token: write
    env:
      STACK_NAME: conexao-zookeeper
      DOCKER_NETWORK_NAME: conexao-network-swarm
      COMPOSE_FILE: docker-compose.yml
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_PEER_PORT: 2888
      ZOOKEEPER_LEADER_PORT: 3888
    steps:
      - name: Checkout
        uses: actions/checkout@v4.3.0
        with:
          fetch-depth: 1
          clean: true

      - name: Pre-deploy environment check
        run: |
          echo 'ğŸ” Verificando ambiente antes do deploy...'
          echo "GitHub Actor: ${{ github.actor }}"
          echo "Repository: ${{ github.repository }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Ref: ${{ github.ref }}"
          
          # Verificar se hÃ¡ alguma variÃ¡vel de ambiente suspeita
          echo 'ğŸ” Verificando variÃ¡veis de ambiente que podem conter segredos...'
          env | grep -i -E "(keyvault|secret|token|password)" || echo "Nenhuma variÃ¡vel suspeita encontrada"
          
          echo 'âœ… VerificaÃ§Ã£o de ambiente concluÃ­da'

      - name: Pre-deployment validation
        run: |
          set -Eeuo pipefail
          echo "ğŸ” Validando ambiente antes do deploy..."
          
          # Verificar se Docker estÃ¡ rodando
          if ! docker info >/dev/null 2>&1; then
            echo "âŒ Docker nÃ£o estÃ¡ rodando ou nÃ£o estÃ¡ acessÃ­vel"
            exit 1
          fi
          echo "âœ… Docker estÃ¡ rodando"
          
          # Verificar modo Swarm
          if ! docker info 2>/dev/null | grep -q "Swarm: active"; then
            echo "âš ï¸ Docker Swarm nÃ£o estÃ¡ ativo (pode ser necessÃ¡rio iniciar)"
          else
            echo "âœ… Docker Swarm estÃ¡ ativo"
          fi
          
          # Verificar espaÃ§o em disco
          available_space=$(df -h . | awk 'NR==2 {print $4}' | sed 's/G//')
          if (( $(echo "$available_space < 2" | bc -l) )); then
            echo "âš ï¸ EspaÃ§o em disco baixo: ${available_space}GB disponÃ­vel"
          else
            echo "âœ… EspaÃ§o em disco suficiente: ${available_space}GB disponÃ­vel"
          fi
          
          # Verificar memÃ³ria disponÃ­vel
          available_mem=$(free -g | awk 'NR==2{printf "%.0f", $7}')
          if [[ $available_mem -lt 2 ]]; then
            echo "âš ï¸ MemÃ³ria disponÃ­vel baixa: ${available_mem}GB"
          else
            echo "âœ… MemÃ³ria disponÃ­vel: ${available_mem}GB"
          fi

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Confirm Key Vault usage
        if: vars.AZURE_KEYVAULT_NAME != ''
        run: |
          echo 'â„¹ï¸ Key Vault configurado mas nÃ£o utilizado (Zookeeper nÃ£o requer segredos externos)'
          echo 'âœ… Seguindo polÃ­tica de mÃ­nimo necessÃ¡rio - nenhum segredo do Key Vault Ã© requerido'
          echo 'ğŸ”’ Nenhum segredo serÃ¡ buscado do Key Vault neste deploy'

      - name: Explicit no-secrets declaration
        run: |
          echo 'âœ… DeclaraÃ§Ã£o explÃ­cita: Este deploy nÃ£o consome segredos do Azure Key Vault'
          echo 'âœ… Zookeeper estÃ¡ sendo deployado com configuraÃ§Ãµes padrÃ£o e sem dependÃªncias externas'
          echo 'âœ… Todas as configuraÃ§Ãµes necessÃ¡rias estÃ£o no docker-compose.yml'

      - name: Debug - Verify no Key Vault secrets requested
        run: |
          echo 'ğŸ” Verificando se nenhum comando estÃ¡ tentando buscar segredos do Key Vault...'
          echo 'âœ… Este workflow nÃ£o contÃ©m comandos az keyvault secret download/show'
          echo 'âœ… Este workflow nÃ£o busca nenhum segredo especÃ­fico do Key Vault'
          echo 'âœ… ConfiguraÃ§Ã£o seguindo polÃ­tica de mÃ­nimo necessÃ¡rio'

      - name: Ensure Swarm resources
        run: |
          set -Eeuo pipefail
          for volume in zookeeper_data zookeeper_logs; do
            if ! docker volume ls | grep -q "${volume}$"; then
              echo "ğŸ“ Criando volume $volume"
              docker volume create "$volume"
            else
              echo "âœ… Volume $volume jÃ¡ existe"
            fi
          done
          for volume in zookeeper_data zookeeper_logs; do
            docker run --rm -v "${volume}:/var/lib/zookeeper" alpine:3.20 \
              sh -c 'chown -R 1000:1000 /var/lib/zookeeper' || true
          done
          if ! docker network ls | grep -q "$DOCKER_NETWORK_NAME"; then
            echo "ğŸŒ Criando rede $DOCKER_NETWORK_NAME"
            docker network create --driver overlay "$DOCKER_NETWORK_NAME"
          else
            echo "âœ… Rede $DOCKER_NETWORK_NAME jÃ¡ existe"
          fi

      - name: Deploy stack
        run: |
          set -Eeuo pipefail
          docker compose -f "$COMPOSE_FILE" config -q
          docker stack deploy -c "$COMPOSE_FILE" "$STACK_NAME"
          echo "â³ Aguardando estabilizaÃ§Ã£o..."
          sleep 30

      - name: Health check
        run: |
          set -Eeuo pipefail
          service="${STACK_NAME}_zookeeper"
          attempts=18
          for attempt in $(seq 1 "$attempts"); do
            echo "ğŸ” Tentativa $attempt/$attempts"
            container=$(docker ps --filter "name=${service}" -q | head -n1)
            if [[ -n "$container" ]]; then
              # Verificar logs de inicializaÃ§Ã£o
              if docker logs "$container" 2>/dev/null | grep -q "binding to port"; then
                echo "âœ… Logs indicam inicializaÃ§Ã£o"
              fi
              
              # Verificar se a porta 2181 estÃ¡ ativa
              if docker exec "$container" ss -tuln 2>/dev/null | grep -q ":2181 "; then
                echo "âœ… Porta 2181 ativa"
              fi
              
              # Verificar se o processo Zookeeper estÃ¡ rodando
              if docker exec "$container" ps aux 2>/dev/null | grep -q "[q]uorumPeerMain"; then
                echo "âœ… Processo Zookeeper ativo"
              fi
              
              # Testar conectividade real com zkCli
              if docker exec "$container" /opt/zookeeper/bin/zkCli.sh ls / 2>/dev/null | grep -q "zookeeper"; then
                echo "âœ… Zookeeper respondendo a comandos"
                exit 0
              fi
              
              # Teste alternativo com nc se zkCli nÃ£o estiver disponÃ­vel
              if docker exec "$container" nc -z localhost 2181 2>/dev/null; then
                echo "âœ… ConexÃ£o TCP na porta 2181 funcionando"
                exit 0
              fi
            fi
            sleep 10
          done
          echo "âŒ Health check falhou apÃ³s $attempts tentativas"
          echo "ğŸ“‹ Status do serviÃ§o:"
          docker service ps "$service" || true
          echo "ğŸ“‹ Logs do serviÃ§o:"
          docker service logs "$service" --tail 100 || true
          echo "ğŸ“‹ Containers ativos:"
          docker ps -a | grep zookeeper || true
          exit 1

      - name: Post-deploy summary
        run: |
          set -Eeuo pipefail
          docker service ls | grep -E "(zookeeper|NAME)" || true
          echo "âœ… Deploy concluÃ­do"
