# ğŸ“‹ GUIA DE RESOLUÃ‡ÃƒO DE PROBLEMAS DE CI/CD PARA PROJETOS CONEXÃƒO DE SORTE

## ğŸ¯ OBJETIVO
Este guia documenta os problemas comuns encontrados nos pipelines CI/CD e como resolvÃª-los, baseado na experiÃªncia com o projeto `conexao-de-sorte-rabbitmq-infraestrutura`.

---

## ğŸš¨ PROBLEMA 1: Runner NÃ£o Encontrado ("Waiting for a runner...")

### Sintomas
- Pipeline fica travado em "Waiting for a runner..."
- Runner estÃ¡ online mas nÃ£o pega o job
- Mensagem de erro sobre labels incompatÃ­veis

### Causa
O workflow contÃ©m labels que nÃ£o existem no runner self-hosted.

### âœ… SoluÃ§Ã£o

#### Passo 1: Verificar labels do runner
```bash
# No servidor com o runner
sudo ./svc.sh stop
sudo ./svc.sh uninstall
./config.sh remove --token SEU_TOKEN

# Reconfigurar com labels corretos
./config.sh --url https://github.com/sua-org/sua-repo --token SEU_TOKEN --labels "self-hosted,Linux,X64,conexao,NOME_DO_PROJETO"
```

#### Passo 2: Ajustar labels no workflow
**ANTES (INCORRETO):**
```yaml
runs-on: [self-hosted, Linux, X64, srv649924, conexao, conexao-de-sorte-rabbitmq-infraestrutura]
```

**DEPOIS (CORRETO):**
```yaml
runs-on: [self-hosted, Linux, X64, conexao, conexao-de-sorte-rabbitmq-infraestrutura]
```

> âš ï¸ **Importante**: Remova labels especÃ­ficas de mÃ¡quina como `srv649924`

#### Passo 3: Atualizar actionlint.yaml
```yaml
self-hosted-runner:
  labels:
    - self-hosted
    - Linux
    - X64
    - conexao
    - conexao-de-sorte-rabbitmq-infraestrutura
```

---

## ğŸš¨ PROBLEMA 2: ReferÃªncia a Outputs Inexistentes

### Sintomas
- Erro: `Unrecognized named-value: 'has_azure_creds'`
- Step falha por referenciar output que nÃ£o existe

### Causa
O workflow referencia outputs de steps que nÃ£o foram definidos.

### âœ… SoluÃ§Ã£o

#### Remover referÃªncias invÃ¡lidas
**ANTES (INCORRETO):**
```yaml
- name: Azure Login
  if: steps.check_secrets.outputs.has_azure_creds == 'true'
```

**DEPOIS (CORRETO):**
```yaml
# Remova a condiÃ§Ã£o ou substitua por uma vÃ¡lida
- name: Azure Login
  if: env.AZURE_CLIENT_ID != ''
```

---

## ğŸš¨ PROBLEMA 3: ValidaÃ§Ã£o de Secrets

### Sintomas
- Pipeline falha por secrets ausentes
- Mensagem: "âŒ GitHub Secrets obrigatÃ³rios ausentes"

### âœ… SoluÃ§Ã£o

#### Implementar validaÃ§Ã£o robusta
```yaml
- name: Validate Required Secrets
  id: check_secrets
  run: |
    required_secrets=(
      "AZURE_CLIENT_ID"
      "AZURE_TENANT_ID"
      "AZURE_SUBSCRIPTION_ID"
    )
    
    missing=()
    for secret in "${required_secrets[@]}"; do
      if [[ -z "${!secret:-}" ]]; then
        missing+=("$secret")
      fi
    done
    
    if [[ ${#missing[@]} -gt 0 ]]; then
      printf 'âŒ GitHub Secrets obrigatÃ³rios ausentes: %s\n' "${missing[*]}"
      exit 1
    fi
    
    echo "âœ… All required secrets are present"
```

---

## ğŸš¨ PROBLEMA 4: ValidaÃ§Ã£o de SeguranÃ§a

### Sintomas
- Falha na validaÃ§Ã£o de seguranÃ§a
- PossÃ­veis passwords hardcoded

### âœ… SoluÃ§Ã£o

#### Implementar validaÃ§Ã£o de seguranÃ§a
```yaml
- name: Security Validation
  run: |
    # Verificar se nÃ£o hÃ¡ hardcoded passwords
    if grep -r "password.*:" docker-compose.yml | grep -v "\${" | grep -v "#" | grep -v "external:"; then
      echo "âŒ Found potential hardcoded passwords"
      exit 1
    else
      echo "âœ… No hardcoded passwords found"
    fi
```

---

## ğŸ“‹ CHECKLIST PARA NOVOS PROJETOS

### âœ… ConfiguraÃ§Ã£o Inicial
- [ ] Criar arquivo `.github/workflows/ci-cd.yml`
- [ ] Criar arquivo `.github/actionlint.yaml`
- [ ] Configurar GitHub Secrets necessÃ¡rios
- [ ] Verificar labels do runner self-hosted

### âœ… ValidaÃ§Ãµes ObrigatÃ³rias
- [ ] Validar sintaxe do docker-compose.yml
- [ ] Verificar ausÃªncia de hardcoded passwords
- [ ] Validar secrets obrigatÃ³rios
- [ ] Testar pipeline em branch de desenvolvimento

### âœ… Boas PrÃ¡ticas
- [ ] Usar versÃµes fixas das actions (ex: `@v4.3.0`)
- [ ] Implementar timeout nos jobs
- [ ] Adicionar concurrency control
- [ ] Usar variÃ¡veis de ambiente para valores reutilizÃ¡veis

---

## ğŸ”§ TEMPLATE DE WORKFLOW CORRIGIDO

```yaml
name: "ğŸš€ Infrastructure â€“ CI/CD Pipeline"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  SERVICE_NAME: seu-servico-infrastructure

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-and-build:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4.3.0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-yaml

      - name: Validate Docker Compose
        run: |
          docker compose -f docker-compose.yml config -q
          echo "âœ… Docker Compose syntax is valid"

      - name: Security Validation
        run: |
          if grep -r "password.*:" docker-compose.yml | grep -v "\${" | grep -v "#" | grep -v "external:"; then
            echo "âŒ Found potential hardcoded passwords"
            exit 1
          else
            echo "âœ… No hardcoded passwords found"
          fi

      - name: Validate Required Secrets
        run: |
          required_secrets=("DOCKER_REGISTRY_USER" "DOCKER_REGISTRY_PASS")
          missing=()
          for secret in "${required_secrets[@]}"; do
            if [[ -z "${!secret:-}" ]]; then
              missing+=("$secret")
            fi
          done
          
          if [[ ${#missing[@]} -gt 0 ]]; then
            printf 'âŒ GitHub Secrets obrigatÃ³rios ausentes: %s\n' "${missing[*]}"
            exit 1
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4.5.0
        with:
          name: configs
          path: |
            docker-compose.yml

  deploy-selfhosted:
    needs: validate-and-build
    runs-on: [self-hosted, Linux, X64, conexao, NOME_DO_PROJETO]
    timeout-minutes: 15
    if: github.ref == 'refs/heads/main'
    env:
      DOCKER_NETWORK_NAME: conexao-network-swarm
      STACK_NAME: conexao-seu-servico
      COMPOSE_FILE: docker-compose.yml
    steps:
      - uses: actions/checkout@v4.3.0
        with:
          clean: true
          fetch-depth: 1

      - name: Download artifacts
        uses: actions/download-artifact@v4.1.8
        with:
          name: configs
          path: .

      - name: ğŸš€ Deploy Stack
        run: |
          echo "ğŸš€ Iniciando deploy com Docker Swarm..."
          if docker stack ls | grep -q "$STACK_NAME"; then
            echo "ğŸ—‘ï¸ Removendo stack existente..."
            docker stack rm "$STACK_NAME"
            sleep 10
          fi
          docker stack deploy -c "$COMPOSE_FILE" "$STACK_NAME"
          echo "â° Aguardando estabilizaÃ§Ã£o..."
          sleep 30

      - name: âœ… Healthcheck
        run: |
          echo "ğŸ” Validando saÃºde do serviÃ§o..."
          timeout=180
          elapsed=0
          health_passed=false
          
          while [ $elapsed -lt $timeout ] && [ "$health_passed" = false ]; do
            CONTAINER=$(docker ps -q -f name="${STACK_NAME}_seu-servico" | head -1)
            if [ -n "$CONTAINER" ]; then
              # Adicione seu health check especÃ­fico aqui
              if docker exec "$CONTAINER" seu-comando-de-healthcheck 2>/dev/null; then
                echo "âœ… Health check passed"
                health_passed=true
                break
              fi
            fi
            sleep 10
            elapsed=$((elapsed + 10))
          done
          
          if [ "$health_passed" = false ]; then
            echo "âš ï¸ Health check nÃ£o passou em $timeout segundos"
            exit 1
          fi
```

---

## ğŸ“š REFERÃŠNCIAS

- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [Docker Swarm Deploy](https://docs.docker.com/engine/swarm/stack-deploy/)
- [Actionlint - GitHub Action Linter](https://github.com/rhymond/actionlint)

---

## ğŸ“ NOTAS DE VERSÃƒO

**v1.0.0 - 2024-01-XX**
- âœ… Guia inicial criado baseado na experiÃªncia com rabbitmq-infraestrutura
- âœ… Problemas comuns documentados e solucionados
- âœ… Template de workflow otimizado e validado

**PrÃ³ximas melhorias:**
- Adicionar mais exemplos de health checks especÃ­ficos por serviÃ§o
- Criar scripts de validaÃ§Ã£o automatizados
- Documentar troubleshooting avanÃ§ado
